/*!
 * @authors yusen
 * @date    2017-01-04 21:34:19
 * @github  https://github.com/yscoder/Calendar
 */
!function(t,e){"function"==typeof define&&define.amd?define("calendar",["jquery"],e):"object"==typeof exports?module.exports=e(require("jquery")):e(t.jQuery)}(this,function(t){function e(t){return"[object Date]"===m.call(t)}function a(t){return"[object String]"===m.call(t)}function i(t){return t.getAttribute("class")||t.getAttribute("className")}function n(t,e){for(var a=0;a<e.length;a++)if(e[a]==t){e.splice(a,1);break}}function s(e,a){this.$element=t(e),this.options=t.extend({},t.fn.calendar.defaults,a),this.$element.addClass("calendar "+this.options.customClass),this.width=this.options.width,this.height=this.options.height,this.date=this.options.date,this.selectedRang=this.options.selectedRang,this.multiArray=[],this.data=this.options.data,this.init()}var r={width:280,height:280,zIndex:1,trigger:null,offset:[0,1],customClass:"",view:"date",date:new Date,format:"yyyy/mm/dd",startWeek:0,weekArray:["日","一","二","三","四","五","六"],monthArray:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],selectedRang:null,data:null,label:"{d}\n{v}",prev:"&lt;",next:"&gt;",viewChange:t.noop,onSelected:function(t,e,a){},onMouseenter:t.noop,onClose:t.noop,onMultiSelected:function(t){}},o="data-calendar-day",h={date:"calendar-d",month:"calendar-m"},l='style="width:{w}px;height:{h}px;line-height:{h}px"',d="<li "+l+">{wk}</li>",c="<li "+l+' class="{class}" {action}="{date}">{value}</li>',u="<li "+l+" data-calendar-month>{m}</li>",p=['<div class="calendar-inner">','<div class="calendar-views">','<div class="view view-date">','<div class="calendar-hd">','<a href="javascript:;" data-calendar-display-date class="calendar-display">','{yyyy}/<span class="m">{mm}</span>',"</a>",'<div class="calendar-arrow">','<span class="prev" data-calendar-arrow-date>{prev}</span>','<span class="next" data-calendar-arrow-date>{next}</span>',"</div>","</div>",'<div class="calendar-ct">','<ol class="week">{week}</ol>','<ul class="date-items"></ul>',"</div>","</div>",'<div class="view view-month">','<div class="calendar-hd">','<a href="javascript:;" data-calendar-display-month class="calendar-display">{yyyy}</a>','<div class="calendar-arrow">','<span class="prev" data-calendar-arrow-month>{prev}</span>','<span class="next" data-calendar-arrow-month>{next}</span>',"</div>","</div>",'<ol class="calendar-ct month-items">{month}</ol>',"</div>","</div>","</div>",'<div class="calendar-label"><p>HelloWorld</p><i></i></div>'],m=Object.prototype.toString;String.prototype.repeat=function(t){return this.replace(/\{\w+\}/g,function(e){var a=e.replace(/\{|\}/g,"");return t[a]||""})},String.prototype.toDate=function(){var t=(new Date,this.replace(/\d/g,"").charAt(0)),e=this.split(t);return new Date(parseInt(e[0]),parseInt(e[1])-1,parseInt(e[2]))},Date.prototype.format=function(t){var e=this.getFullYear(),a=this.getMonth()+1,i=this.getDate();return t.replace("yyyy",e).replace("mm",a).replace("dd",i)},Date.prototype.isSame=function(t,a,i){if(e(t)){var n=t;t=n.getFullYear(),a=n.getMonth()+1,i=n.getDate()}return this.getFullYear()===t&&this.getMonth()+1===a&&this.getDate()===i},Date.prototype.add=function(t){this.setDate(this.getDate()+t)},Date.prototype.minus=function(t){this.setDate(this.getDate()-t)},Date.prototype.clearTime=function(t){return this.setHours(0),this.setSeconds(0),this.setMinutes(0),this.setMilliseconds(0),this},Date.isLeap=function(t){return t%100!=0&&t%4==0||t%400==0},Date.getDaysNum=function(t,e){var a=31;switch(e){case 2:a=this.isLeap(t)?29:28;break;case 4:case 6:case 9:case 11:a=30}return a},Date.getSiblingsMonth=function(t,e,a){var i=new Date(t,e-1);return i.setMonth(e-1+a),{y:i.getFullYear(),m:i.getMonth()+1}},Date.getPrevMonth=function(t,e,a){return this.getSiblingsMonth(t,e,0-(a||1))},Date.getNextMonth=function(t,e,a){return this.getSiblingsMonth(t,e,a||1)},Date.tryParse=function(t){return t?e(t)?t:t.toDate():t},s.prototype={constructor:s,getDayAction:function(t){var e=o;if(this.selectedRang){var a=Date.tryParse(this.selectedRang[0]),i=Date.tryParse(this.selectedRang[1]);(a&&t<a.clearTime()||i&&t>i.clearTime())&&(e="disabled")}return e},getDayData:function(t){var e,a=this.data;if(a)for(var i=0,n=a.length;i<n;i++){var s=a[i];t.isSame(Date.tryParse(s.date))&&(e=s.value)}return e},getDayType:function(t){var e,a=this.data;if(a)for(var i=0,n=a.length;i<n;i++){var s=a[i];t.isSame(Date.tryParse(s.date))&&(e=s.type)}return e},getDayItem:function(e,a,i,n){var s,r,o=this.date,h=new Date(e,a-1,i),l={w:this.width/7,h:this.height/7,value:i};if(o.isSame(e,a,i),l.class=1===n?"old":3===n?"new":"",o.isSame(e,a,i)&&(l.class+=" now"),l.date=h.format(this.options.format),l.action=this.getDayAction(h),s=this.getDayData(h),dateType=this.getDayType(h),r=t(c.repeat(l)),s)if(r.data("markData",s),dateType)switch(dateType){case"1":r.html(i+'<i class="offday">休</i>');break;case"2":r.html(i+'<i class="workday">班</i>');break;default:r.html(i+'<i class="dot"></i>')}else r.html(i+'<i class="dot"></i>');return r},getDaysHtml:function(a,i){var n,s,r,o,h,l,d=(this.date,t('<ol class="days"></ol>'));e(a)?(n=a.getFullYear(),s=a.getMonth()+1):(n=Number(a),s=Number(i)),r=new Date(n,s-1,1).getDay()||7,l=r-this.options.startWeek,o=Date.getDaysNum(n,s),h=Date.getPrevMonth(n,s),prevDaysNum=Date.getDaysNum(n,h.m),nextM=Date.getNextMonth(n,s);for(var c=0,u=prevDaysNum-l+1;u<=prevDaysNum;u++,c++)d.append(this.getDayItem(h.y,h.m,u,1));for(var p=1;p<=o;p++,c++)d.append(this.getDayItem(n,s,p,2));for(var m=1,f=42-c;m<=f;m++)d.append(this.getDayItem(nextM.y,nextM.m,m,3));return t("<li></li>").width(this.options.width).append(d)},getWeekHtml:function(){for(var t=[],e=this.options.weekArray,a=this.options.startWeek,i=e.length,n=this.width/7,s=this.height/7,r=a;r<i;r++)t.push(d.repeat({w:n,h:s,wk:e[r]}));for(var o=0;o<a;o++)t.push(d.repeat({w:n,h:s,wk:e[o]}));return t.join("")},getMonthHtml:function(){for(var t=this.options.monthArray,e=[],a=this.width/4,i=this.height/4,n=0;n<12;n++)e.push(u.repeat({w:a,h:i,m:t[n]}));return e.join("")},setMonthAction:function(t){var e=this.date.getMonth()+1;this.$monthItems.children().removeClass("now"),t===this.date.getFullYear()&&this.$monthItems.children().eq(e-1).addClass("now")},fillStatic:function(){var t={prev:this.options.prev,next:this.options.next,week:this.getWeekHtml(),month:this.getMonthHtml()};this.$element.html(p.join("").repeat(t))},updateDisDate:function(t,e){this.$disDate.html('{year}/<span class="m">{month}</span>'.repeat({year:t,month:e}))},updateDisMonth:function(t){this.$disMonth.html(t)},fillDateItems:function(t,e){var a=[Date.getPrevMonth(t,e),{y:t,m:e},Date.getNextMonth(t,e)];this.$dateItems.html("");for(var i=0;i<3;i++){var n=this.getDaysHtml(a[i].y,a[i].m);this.$dateItems.append(n)}},hide:function(t,e,a){this.$trigger.val(e.format(this.options.format)),this.options.onClose.call(this,t,e,a),this.$element.hide()},setPosition:function(){var t=this.$trigger.offset(),e=this.options.offset;this.$element.css({left:t.left+e[0]+"px",top:t.top+this.$trigger.outerHeight()+e[1]+"px"})},trigger:function(){this.$trigger=t(this.options.trigger);var e=this,a=e.$element;a.addClass("calendar-modal").css("zIndex",e.options.zIndex),t(document).click(function(i){e.$trigger[0]==i.target||t.contains(a[0],i.target)||a.hide()}).on("click",this.options.trigger,function(){this.$trigger=t(this),e.setPosition(),a.show()}),t(window).resize(function(){e.setPosition()})},render:function(){this.$week=this.$element.find(".week"),this.$dateItems=this.$element.find(".date-items"),this.$monthItems=this.$element.find(".month-items"),this.$label=this.$element.find(".calendar-label"),this.$disDate=this.$element.find("[data-calendar-display-date]"),this.$disMonth=this.$element.find("[data-calendar-display-month]");var t=this.date.getFullYear(),e=this.date.getMonth()+1;this.updateDisDate(t,e),this.updateMonthView(t),this.fillDateItems(t,e),this.options.trigger&&this.trigger()},setView:function(t){this.$element.removeClass(h.date+" "+h.month).addClass(h[t]),this.view=t},updateDateView:function(e,a,i,n){a=a||this.date.getMonth()+1;var s=this,r=this.$dateItems,o={prev:function(){var i=Date.getPrevMonth(e,a),o=Date.getPrevMonth(e,a,2),h=s.getDaysHtml(o.y,o.m);a=i.m,e=i.y,r.animate({marginLeft:0},300,"swing",function(){r.children(":last").remove(),r.prepend(h).css("margin-left","-100%"),t.isFunction(n)&&n.call(s)})},next:function(){var i=Date.getNextMonth(e,a),o=Date.getNextMonth(e,a,2),h=s.getDaysHtml(o.y,o.m);a=i.m,e=i.y,r.animate({marginLeft:"-200%"},300,"swing",function(){r.children(":first").remove(),r.append(h).css("margin-left","-100%"),t.isFunction(n)&&n.call(s)})}};return i?o[i]():this.fillDateItems(e,a),this.updateDisDate(e,a),this.setView("date"),{y:e,m:a}},updateMonthView:function(t){this.updateDisMonth(t),this.setMonthAction(t),this.setView("month")},getDisDateValue:function(){var t=this.$disDate.html().split("/");return[Number(t[0]),Number(t[1].match(/\d{1,2}/)[0])]},selectedDay:function(t,e){var a=this.getDisDateValue(),i=a[0],n=a[1],s=function(){this.$dateItems.children(":eq(1)").find("["+o+"]:not(.new, .old)").removeClass("selected").filter(function(e){return parseInt(this.innerHTML)===t}).addClass("selected")};if(e){var r=this.updateDateView(i,n,{old:"prev",new:"next"}[e],s);i=r.y,n=r.m,this.options.viewChange("date",i,n)}else s.call(this);return new Date(i,n-1,t)},showLabel:function(t,e,a,i){var n=this.$label;n.find("p").html(this.options.label.repeat({m:e,d:a.format(this.options.format),v:i}).replace(/\n/g,"<br>"));var s=n.outerWidth(),r=n.outerHeight();n.css({left:t.pageX-s/2+"px",top:t.pageY-r-20+"px",zIndex:this.options.zIndex+1}).show()},hasLabel:function(){return!!this.options.label&&(t("body").append(this.$label),!0)},event:function(){var e=this,a=e.options.viewChange;e.$element.on("click","[data-calendar-display-date]",function(){var t=e.getDisDateValue();e.updateMonthView(t[0],t[1]),a("month",t[0],t[1])}).on("click","[data-calendar-display-month]",function(){var t=this.innerHTML;e.updateDateView(t),a("date",t)}),e.$element.on("click","[data-calendar-arrow-date]",function(){var t=e.getDisDateValue(),n=i(this),s=t[0],r=t[1],o=e.updateDateView(s,r,n,function(){a("date",o.y,o.m)})}).on("click","[data-calendar-arrow-month]",function(){var t=Number(e.$disMonth.html());t="prev"===i(this)?t-1:t+1,e.updateMonthView(t),a("month",t)});var s=!1,r=this.multiArray;t(window).keydown(function(t){17==t.keyCode&&(s=!0)}).keyup(function(t){17==t.keyCode&&(s=!1)}),e.$element.on("click","["+o+"]",function(a){var o=parseInt(this.innerHTML),h=i(this),l=/new|old/.test(h)?h.match(/new|old/)[0]:"";if(s){if("LI"===t(this)[0].tagName.toUpperCase()){t(this).toggleClass("selected");var d=t(this).attr("data-calendar-day"),c=t(this).hasClass("selected");c?r.push(d):n(d,r),e.options.onMultiSelected.call(this,r)}}else{r.splice(0,r.length),r.push(t(this).attr("data-calendar-day"));var d=e.selectedDay(o,l);e.options.onSelected.call(this,"date",d,t(this).data("markData")),e.$trigger&&e.hide("date",d,t(this).data("markData"))}}).on("click","[data-calendar-month]",function(){var i=Number(e.$disMonth.html()),n=t(this).index()+1;e.updateDateView(i,n),a("date",i,n),e.options.onSelected.call(this,"month",new Date(i,n-1))}),e.$element.on("mouseenter","["+o+"]",function(a){var i=t(this),n=i.attr(o).toDate();e.hasLabel()&&i.data("markData")&&e.showLabel(a,"date",n,i.data("markData")),e.options.onMouseenter.call(this,"date",n,i.data("markData"))}).on("mouseleave","["+o+"]",function(){e.$label.hide()})},resize:function(){var t=this.width,e=this.height,a=this.$element.find(".calendar-hd").outerHeight();this.$element.width(t).height(e+a).find(".calendar-inner, .view").css("width",t+"px"),this.$element.find(".calendar-ct").width(t).height(e)},init:function(){this.fillStatic(),this.resize(),this.render(),this.view=this.options.view,this.setView(this.view),this.event()},setData:function(t){if(this.data=t,"date"===this.view){var e=this.getDisDateValue();this.fillDateItems(e[0],e[1])}else"month"===this.view&&this.updateMonthView(this.$disMonth.html())},getMultiSelect:function(t){t(this.multiArray)},setDate:function(t){var e=Date.tryParse(t);this.updateDateView(e.getFullYear(),e.getMonth()+1),this.selectedDay(e.getDate())},methods:function(t,e){if("[object Function]"===m.call(this[t]))return this[t].apply(this,e)}},t.fn.calendar=function(e){var i,n=this.data("calendar"),r=[].slice.call(arguments);return n?a(e)?(i=e,r.shift(),n.methods(i,r)):this:this.each(function(){return t(this).data("calendar",new s(this,e))})},t.fn.calendar.defaults=r});